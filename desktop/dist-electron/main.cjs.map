{
  "version": 3,
  "sources": ["../src/main/main.ts"],
  "sourcesContent": ["// main process. creates window, runs monitoring loop, and handles IPC from renderer\r\n\r\nimport { app, BrowserWindow, ipcMain } from 'electron';\r\nimport path from 'node:path';\r\nimport fs from 'node:fs';\r\nimport activeWin from 'active-win';\r\n\r\nlet mainWindow: BrowserWindow | null = null;\r\nconst DEFAULT_BLACKLIST = ['youtube', 'twitter', 'instagram', 'steam'];\r\n\r\nfunction normalizeBlacklist(values: unknown): string[] {\r\n  if (!Array.isArray(values)) return [];\r\n  const unique = new Set<string>();\r\n  for (const value of values) {\r\n    const normalized = String(value).toLowerCase().trim();\r\n    if (normalized) unique.add(normalized);\r\n  }\r\n  return [...unique];\r\n}\r\n\r\nfunction getSettingsPath() {\r\n  return path.join(app.getPath('userData'), 'focus-fee-settings.json');\r\n}\r\n\r\nfunction loadPersistedBlacklist(): string[] {\r\n  try {\r\n    const raw = fs.readFileSync(getSettingsPath(), 'utf-8');\r\n    const parsed = JSON.parse(raw) as { blacklist?: unknown };\r\n    const loaded = normalizeBlacklist(parsed?.blacklist);\r\n    return loaded.length > 0 ? loaded : [...DEFAULT_BLACKLIST];\r\n  } catch {\r\n    return [...DEFAULT_BLACKLIST];\r\n  }\r\n}\r\n\r\nfunction savePersistedBlacklist(blacklist: string[]) {\r\n  try {\r\n    fs.writeFileSync(\r\n      getSettingsPath(),\r\n      JSON.stringify({ blacklist: normalizeBlacklist(blacklist) }, null, 2),\r\n      'utf-8'\r\n    );\r\n  } catch {\r\n    // ignore write errors in dev\r\n  }\r\n}\r\n\r\ntype SessionState = {       // state of the current focus session\r\n  running: boolean;\r\n  paused: boolean;\r\n  blacklist: string[];\r\n  centsOwed: number;\r\n  feePerMin: number; // $/minute, e.g. 0.25\r\n  lastCheck: number;\r\n};\r\nconst state: SessionState = {       //initial state of session\r\n  running: false,\r\n  paused: false,\r\n  blacklist: [...DEFAULT_BLACKLIST],\r\n  centsOwed: 0,\r\n  feePerMin: 0.25,\r\n  lastCheck: Date.now(),\r\n};\r\n\r\n// Debounce: require 3 consecutive ticks of same state to avoid flickering\r\nlet lastRawDistracted: boolean | null = null;\r\nlet sameCount = 0;\r\nlet displayedDistracted = false;\r\n\r\nasync function createWindow() {         //creates the desktop window and loads the React app\r\n  mainWindow = new BrowserWindow({\r\n    width: 1100,\r\n    height: 720,\r\n    webPreferences: {\r\n        preload: path.join(__dirname, 'preload.cjs'),\r\n        contextIsolation: true,\r\n        nodeIntegration: false,\r\n},\r\n\r\n \r\n\r\n\r\n  });\r\n\r\n  const isDev = !!process.env.VITE_DEV_SERVER;      // dev commands.  VITE_DEV_SERVER in development mode\r\n  if (isDev) {\r\n    await mainWindow.loadURL(process.env.VITE_DEV_SERVER_URL || 'http://localhost:5173');\r\n  } else {\r\n    await mainWindow.loadFile(path.join(__dirname, '../../dist/index.html'));\r\n  }\r\n\r\n  mainWindow.on('closed', () => {\r\n    mainWindow = null;\r\n  });\r\n}\r\n\r\napp.whenReady().then(() => {\r\n  state.blacklist = loadPersistedBlacklist();\r\n  return createWindow();\r\n});         //lifecycle events\r\napp.on('window-all-closed', () => {\r\n  if (process.platform !== 'darwin') app.quit();\r\n});\r\napp.on('activate', () => {                  //macOS behavior: re-create window when dock icon is clicked and no other windows are open\r\n  if (BrowserWindow.getAllWindows().length === 0) createWindow();\r\n});\r\n\r\n// Domain variations for common sites (window titles may show URL or site name)\r\nconst DOMAIN_VARIATIONS: Record<string, string[]> = {\r\n  youtube: ['youtube', 'youtube.com', 'youtu.be', 'youtube music', 'youtube kids', 'youtube studio'],\r\n  twitter: ['twitter', 'twitter.com', 'x.com', 'x -'],\r\n  x: ['x.com', 'x -'],\r\n  instagram: ['instagram', 'instagram.com'],\r\n  steam: ['steam'],\r\n  reddit: ['reddit', 'reddit.com'],\r\n  tiktok: ['tiktok', 'tiktok.com'],\r\n  netflix: ['netflix', 'netflix.com'],\r\n  twitch: ['twitch', 'twitch.tv'],\r\n};\r\n\r\nfunction expandBlacklistTerms(terms: string[]): string[] {\r\n  const expanded = new Set<string>();\r\n  for (const t of terms) {\r\n    const key = t.toLowerCase().trim();\r\n    const variations = DOMAIN_VARIATIONS[key];\r\n    if (variations) variations.forEach(v => expanded.add(v));\r\n    else expanded.add(key);\r\n  }\r\n  return [...expanded];\r\n}\r\n\r\n// Match window title or app name against blacklist (detects webpage from browser window title)\r\nfunction windowMatchesBlacklist(win: { title?: string; owner?: { name?: string } } | null | undefined, blacklist: string[]): boolean {\r\n  if (!win) return false;\r\n  const title = (win.title || '').toLowerCase();\r\n  const ownerName = (win.owner?.name || '').toLowerCase();\r\n  const terms = expandBlacklistTerms(blacklist);\r\n  return terms.some(b => title.includes(b) || ownerName.includes(b));\r\n}\r\n\r\n// Goal: Use window titles to detect what webpage we're on. When user has a blacklisted\r\n// site full screen (e.g. YouTube), detect it \u2192 show \"Unfocused\" \u2192 charge fees.\r\nsetInterval(async () => {\r\n  if (!state.running || !mainWindow) return;\r\n  try {\r\n    const [activeWindow, openWindows] = await Promise.all([\r\n      activeWin(),\r\n      activeWin.getOpenWindows?.() ?? Promise.resolve([]),\r\n    ]);\r\n    const win = activeWindow ?? (Array.isArray(openWindows) && openWindows.length > 0 ? openWindows[0] : null);\r\n    const win2 = Array.isArray(openWindows) && openWindows.length > 1 ? openWindows[1] : null;\r\n\r\n    const now = Date.now();\r\n    const elapsedMin = (now - state.lastCheck) / 60000;\r\n\r\n    // Fees when focused on blacklisted app (or it's visible in split screen)\r\n    const blacklistAppIsOpen = Array.isArray(openWindows) && openWindows.length > 0 && openWindows.some((w: any) => windowMatchesBlacklist(w, state.blacklist));\r\n    const activeMatches = windowMatchesBlacklist(win, state.blacklist);\r\n    const secondMatches = windowMatchesBlacklist(win2, state.blacklist);\r\n    const titleLower = (win?.title || '').toLowerCase();\r\n    const ownerLower = (win?.owner?.name || '').toLowerCase();\r\n    const isOwnApp = ownerLower.includes('electron') || titleLower.includes('focus fee') || titleLower.includes('focus-fee') || titleLower.includes('focusfee') || ownerLower.includes('focus fee') || ownerLower.includes('focus-fee') || ownerLower.includes('focusfee');\r\n    const rawDistracted = !isOwnApp && (activeMatches || (secondMatches && blacklistAppIsOpen));\r\n\r\n    // Debug: log every ~10 sec to verify detection\r\n    if (Math.floor(now / 10000) !== Math.floor((now - 1500) / 10000)) {\r\n      console.log('[Focus Fee] Active:', win?.title || '(none)', '| Owner:', win?.owner?.name || '(none)');\r\n      console.log('[Focus Fee] Match:', activeMatches, '| isOwn:', isOwnApp, '| distracted:', rawDistracted);\r\n    }\r\n\r\n    // Debounce: when switching TO distracted (YouTube etc), update immediately.\r\n    // When switching back to focused, require 2 consecutive ticks to avoid flicker.\r\n    if (lastRawDistracted === rawDistracted) {\r\n      sameCount++;\r\n      if (sameCount >= 2 || lastRawDistracted === null || rawDistracted) {\r\n        displayedDistracted = rawDistracted;\r\n      }\r\n    } else {\r\n      sameCount = 1;\r\n      if (lastRawDistracted === null || rawDistracted) displayedDistracted = rawDistracted;\r\n    }\r\n    lastRawDistracted = rawDistracted;\r\n\r\n    if (displayedDistracted && !state.paused) {\r\n      state.centsOwed += Math.ceil(elapsedMin * state.feePerMin * 100);\r\n    }\r\n    state.lastCheck = now;\r\n\r\n    const activeTitles = win2 != null\r\n      ? [win?.title || '\u2014', win2?.title || '\u2014']\r\n      : [win?.title || ''];\r\n    mainWindow.webContents.send('tick', {\r\n      distracted: displayedDistracted,\r\n      centsOwed: state.centsOwed,\r\n      activeTitle: activeTitles[0] || '',\r\n      activeTitles,\r\n      activeOwner: win?.owner?.name || '',\r\n      blacklist: state.blacklist,\r\n      paused: state.paused,\r\n    });\r\n  } catch (e) {\r\n    // swallow errors to keep loop alive\r\n  }\r\n}, 1500);\r\n\r\n// IPC handlers for control\r\nipcMain.handle('settings:get', () => {\r\n  return { blacklist: state.blacklist };\r\n});\r\n\r\nipcMain.handle('settings:set-blacklist', (_e, payload: { blacklist?: string[] }) => {\r\n  const next = normalizeBlacklist(payload?.blacklist);\r\n  state.blacklist = next;\r\n  savePersistedBlacklist(next);\r\n  return { ok: true, blacklist: state.blacklist };\r\n});\r\n\r\nipcMain.handle('session:start', (_e, payload: { blacklist: string[]; feePerMin: number }) => {\r\n  state.blacklist = normalizeBlacklist(payload.blacklist);\r\n  savePersistedBlacklist(state.blacklist);\r\n  state.feePerMin = payload.feePerMin;\r\n  state.centsOwed = 0;\r\n  state.lastCheck = Date.now();\r\n  state.running = true;\r\n  state.paused = false;\r\n  lastRawDistracted = null;\r\n  sameCount = 0;\r\n  displayedDistracted = false;\r\n  console.log('[Focus Fee] Blacklist:', state.blacklist);\r\n  return { ok: true };\r\n});\r\n\r\nipcMain.handle('session:pause', () => {\r\n  state.paused = true;\r\n  return { ok: true };\r\n});\r\n\r\nipcMain.handle('session:resume', () => {\r\n  state.paused = false;\r\n  state.lastCheck = Date.now();\r\n  return { ok: true };\r\n});\r\n\r\nipcMain.handle('session:stop', () => {      // stop session and return total cents owed\r\n  state.running = false;\r\n  state.paused = false;\r\n  return { centsOwed: state.centsOwed };\r\n});\r\n"],
  "mappings": "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",
  "names": ["path", "fs", "activeWin"]
}
